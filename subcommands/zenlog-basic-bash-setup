#!/bin/bash

cat <<'EOF'

#==============================================================================
# Simple bash setup script for Bash.
#
# Add the following line to your $HOME/.bashrc file.
#
# . <(zenlog basic-bash-setup)
#==============================================================================

#==============================================================================
# Customize this.
ZENLOG_VIEWER=${ZENLOG_VIEWER:-less}

#==============================================================================
ZENLOG_BIN="${ZENLOG_BIN:-zenlog}"

# Install the basic shell helper functions.
. <("$ZENLOG_BIN" sh-helper)

#==============================================================================
# Pre-post exec hook.
# - Execute "zenlog_bash_postexec $?" in PROMPT_COMMAND.
# - Execute "zenlog_bash_preexec" in PS0.

_postexec() {
    local status=$?
    local lines=$(zenlog_bash_postexec -n "$status")
    echo "[rc=$status log=$($ZENLOG_BIN current-log) (${lines:-n/a} lines) $(pwd)]"
}

_preexec() {
    zenlog_bash_preexec
}

PROMPT_COMMAND="_postexec"
PS0='$(_preexec)'

#==============================================================================
# Set up hot keys.
# - Press ALT+1 on prompt to open the last log.
# - Press ALT+2 on prompt to open the last log file on the web browser *with color*.
#   (Must install a2h.)


open_last_log() {
  "$ZENLOG_BIN" open-current-log
}

open_last_raw() {
  local log="$("$ZENLOG_BIN" current-log -r)"
  local temp="$(tempfile)"

  a2h "$log" > "$temp" || {
    echo "Failed to execute A2H. Install it from https://github.com/omakoto/a2h-rs." 1>&2
    return 1
  }
  "${ZENLOG_RAW_VIEWER:-google-chrome}" "$temp"
}

bind -x '"\e1": "open_last_log"'
bind -x '"\e2": "open_last_raw"'

EOF
